user                          nginx;
pid                           /var/run/nginx.pid;
worker_processes              auto;

error_log                     /dev/stdout;

events {
    worker_connections        1024;
    multi_accept              on;
}

http {
    access_log                /dev/stdout;

    server_tokens             off;

    include                   mime.types;
    default_type              application/octet-stream;

    charset                   utf-8;

    client_max_body_size      10M;

    limit_req_zone            $binary_remote_addr zone=mylimit:10m rate=10r/s;
    limit_req                 zone=mylimit burst=20 nodelay;

    add_header                Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
    add_header                X-Frame-Options "DENY";
    add_header                X-Content-Type-Options "nosniff";
    add_header                Content-Security-Policy "default-src 'self'; script-src 'self'; style-src 'self';";

    ssl_protocols             TLSv1.2 TLSv1.3;
    ssl_ciphers               HIGH:!aNULL:!MD5;
    ssl_session_cache         shared:SSL:10m;
    ssl_session_timeout       10m;
    ssl_prefer_server_ciphers on;
    ssl_dhparam               /etc/nginx/dhparam.pem;

    proxy_http_version        1.1;
    proxy_set_header          Connection "";
    proxy_set_header          Host $host;
    proxy_set_header          X-Real-IP $remote_addr;
    proxy_connect_timeout     5s;
    proxy_send_timeout        30s;
    proxy_read_timeout        30s;
    proxy_buffering           off;
    proxy_buffer_size         4k;
    proxy_buffers             4 32k;
    proxy_busy_buffers_size   64k;
    proxy_ignore_headers      X-Accel-Buffering

    keepalive_timeout         60s;
    keepalive_requests        1000;

    # ---------------
    # -- jublawoma --
    # ---------------
    server {
        server_name           jublawoma.ch;

        listen                443 ssl http2;
        listen                [::]:443 ssl http2;

        ssl_certificate       /path/to/fullchain.pem;
        ssl_certificate_key   /path/to/privkey.pem;

        location / {
            proxy_pass        http://localhost:8000/jublawoma;
        }
    }
    server {
        server_name           api.jublawoma.ch;

        listen                443 ssl http2;
        listen                [::]:443 ssl http2;

        ssl_certificate       /path/to/fullchain.pem;
        ssl_certificate_key   /path/to/privkey.pem;

        location / {
            proxy_pass        http://localhost:8080/jublawoma;
        }
    }

    # ---------------------
    # -- jublawoma admin --
    # ---------------------
    server {
        server_name           admin.jublawoma.ch;

        listen                443 ssl http2;
        listen                [::]:443 ssl http2;

        ssl_certificate       /path/to/fullchain.pem;
        ssl_certificate_key   /path/to/privkey.pem;

        location / {
            proxy_pass        http://localhost:8000/jublawoma-admin;
        }
    }
    server {
        server_name           api.admin.jublawoma.ch;

        listen                443 ssl http2;
        listen                [::]:443 ssl http2;

        ssl_certificate       /path/to/fullchain.pem;
        ssl_certificate_key   /path/to/privkey.pem;

        location / {
            proxy_pass        http://localhost:8080/jublawoma-admin;
        }
    }

    # -------------
    # -- uncle-t --
    # -------------
    server {
        server_name           uncle-t.ch;

        listen                443 ssl http2;
        listen                [::]:443 ssl http2;

        ssl_certificate       /path/to/fullchain.pem;
        ssl_certificate_key   /path/to/privkey.pem;

        location / {
            proxy_pass        http://localhost:8000/unclet;
        }
    }
    server {
        server_name           api.uncle-t.ch;

        listen                443 ssl http2;
        listen                [::]:443 ssl http2;

        ssl_certificate       /path/to/fullchain.pem;
        ssl_certificate_key   /path/to/privkey.pem;

        location / {
            proxy_pass        http://localhost:8080/unclet;
        }
    }

    # -------------------
    # -- uncle-t admin --
    # -------------------
    server {
        server_name           admin.uncle-t.ch;

        listen                443 ssl http2;
        listen                [::]:443 ssl http2;

        ssl_certificate       /path/to/fullchain.pem;
        ssl_certificate_key   /path/to/privkey.pem;

        location / {
            proxy_pass        http://localhost:8000/unclet-admin;
        }
    }
    server {
        server_name           api.admin.uncle-t.ch;

        listen                443 ssl http2;
        listen                [::]:443 ssl http2;

        ssl_certificate       /path/to/fullchain.pem;
        ssl_certificate_key   /path/to/privkey.pem;

        location / {
            proxy_pass        http://localhost:8080/unclet-admin;
        }
    }

    # -------------
    # -- oliumbi --
    # -------------
    server {
        server_name           oliumbi.ch;

        listen                443 ssl http2;
        listen                [::]:443 ssl http2;

        ssl_certificate       /path/to/fullchain.pem;
        ssl_certificate_key   /path/to/privkey.pem;

        location / {
            proxy_pass        http://localhost:8000/oliumbi;
        }
    }
    server {
        server_name           api.oliumbi.ch;

        listen                443 ssl http2;
        listen                [::]:443 ssl http2;

        ssl_certificate       /path/to/fullchain.pem;
        ssl_certificate_key   /path/to/privkey.pem;

        location / {
            proxy_pass http://localhost:8080/oliumbi;
        }
    }

    # -------------------
    # -- oliumbi admin --
    # -------------------
    server {
        server_name           admin.oliumbi.ch;

        listen                443 ssl http2;
        listen                [::]:443 ssl http2;

        ssl_certificate       /path/to/fullchain.pem;
        ssl_certificate_key   /path/to/privkey.pem;

        location / {
            proxy_pass        http://localhost:8000/oliumbi-admin;
        }
    }
    server {
        server_name           api.admin.oliumbi.ch;

        listen                443 ssl http2;
        listen                [::]:443 ssl http2;

        ssl_certificate       /path/to/fullchain.pem;
        ssl_certificate_key   /path/to/privkey.pem;

        location / {
            proxy_pass        http://localhost:8080/oliumbi-admin;
        }
    }

    # -----------
    # -- https --
    # -----------
    server {
        server_name           jublawoma.ch api.jublawoma.ch \
                              admin.jublawoma.ch api.admin.jublawoma.ch \
                              uncle-t.ch api.uncle-t.ch \
                              admin.uncle-t.ch api.admin.uncle-t.ch \
                              oliumbi.ch api.oliumbi.ch \
                              admin.oliumbi.ch api.admin.oliumbi.ch;

        listen                80;
        listen                [::]:80;

        return                301 https://$host$request_uri;
    }
}
